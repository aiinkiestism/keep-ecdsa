name: Go

#TODO: extend the conditions once workflow gets tested together with other workflows 
on:  
  push:
    branches: 
      - rfc-18/try-golang-test-annotations-gh-action-wip
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: satackey/action-docker-layer-caching@v0.0.11
        continue-on-error: true # ignore the failure of a step and avoid terminating the job
      - name: Run Docker build
        run: |
           docker build \
             --target gobuild \
             --tag go-build-env . 
            docker build \
            --tag keep-ecdsa .
      - name: Run Go tests
        run: |
          docker run \
            --workdir /go/src/github.com/keep-network/keep-ecdsa \
            go-build-env \
            go test -json ./... > test-results.json
      - name: Annotate tests
        if: always()
        uses: guyarb/golang-test-annoations@v0.3.0
        with:
          test-results: test-results.json